<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.js"></script>
  <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}">
  <script th:inline="javascript">
    const equals = /*[[${equals}]]*/ '';
      if (equals == false) {
          alert("권한이 없습니다");
          history.back();
      }
  </script>
</head>
<body>
<div th:replace="fragment/header :: header"></div>
<div th:replace="fragment/nav :: nav"></div>
<main class="container mt-5 pt-3">
  <div th:include="main/notice/modifymain :: modifymain"></div>
</main>
<div th:replace="fragment/footer :: footer"></div>
<script th:inline="javascript">
  Dropzone.autoDiscover = false;
  var myDropzone = new Dropzone("#fileDropzone", {
    url: '/noticemodify_proc', // URL이 올바르게 설정되었는지 확인
    autoProcessQueue: false,
    maxFilesize: 10, // 파일 크기 제한 (MB)
    dictDefaultMessage: "여기를 클릭하거나 파일을 마우스로 끌어오세요",
    paramName: "ofile", // 파일 이름 매핑
    maxFiles: 5, // 최대 파일 개수
    addRemoveLinks: true, // 파일 제거 링크 추가
    dictFileTooBig: "파일 크기가 너무 큽니다. 최대 크기는 10MB입니다.",
    init: function () {
        this.on("addedfile", (file) => {
            // mock file로 추가할 경우, isExisting 속성을 true로 설정
            file.isExisting = true; // mock file로 설정
            file.sfile = file.name; // sfile 속성에 파일 이름을 저장
        });
    }
  });

document.addEventListener("DOMContentLoaded", () => {
    // 파일 목록 가져오기
    var files = JSON.parse(/*[[${file}]]*/ '[]');
    var existingFiles = [];
    // 파일 추가
    files.forEach(function(fileInfo) {
        let mockFile = {
        name: fileInfo.ofile,
        size: fileInfo.size || 12345,
        accepted: true, // 파일이 accepted 상태로 처리되도록 설정
        status: Dropzone.SUCCESS, // Dropzone의 성공 상태로 설정
        upload: { progress: 100, total: fileInfo.size || 12345, bytesSent: fileInfo.size || 12345 } // 업로드 완료 상태로 설정
        };
        myDropzone.emit("addedfile", mockFile);
        myDropzone.emit("thumbnail", mockFile, `/uploads/${fileInfo.sfile}`);
        myDropzone.emit("complete", mockFile);
        myDropzone.emit("success", mockFile);
        myDropzone.files.push(mockFile);
        myDropzone.accept(mockFile, () => {});
    });
    var removedFiles = [];
    myDropzone.on("removedfile",  (file) => {
       if (file.isExisting) {
        // files 배열에서 삭제된 파일의 sfile을 찾기
        const fileInfo = files.find(f => f.ofile === file.name);
        if (fileInfo) {
            console.log(fileInfo.sfile); // 찾은 파일의 sfile 출력
            removedFiles.push(fileInfo.sfile); // 삭제된 파일의 sfile을 배열에 저장
        }
    }
    });

    const validateForm = () => {
        const checks = [
            { check: $(".title").val(), message: "제목을 입력해주세요", field: ".title" },
            { check: $(".content").val(), message: "내용을 입력해주세요", field: ".content" },
        ];
        for (const { check, message, field } of checks) {
            if (check === undefined ||check.length === 0) {
                alert(message);
                $(field).focus();
                return false;
            }
        }
        return true;
    };
    $(".onsubmit").on("submit", (event) => {

        event.preventDefault(); // 기본 제출 방지
        if (validateForm()) {
            const myDropzone = Dropzone.forElement("#fileDropzone");
            const formData = new FormData();
            existingFiles.forEach((existingFile) => {
                 formData.append("existingFiles", existingFile);
            });
            formData.append("idx",$("input[name='idx']").val())
            formData.append("userid", $("input[name='userid']").val());
            formData.append("nick", $("input[name='nick']").val());
            formData.append("grade", $("input[name='grade']").val());
            formData.append("title", $(".title").val());
            formData.append("content", $(".content").val());

            if(removedFiles !=null)
            {
              removedFiles.forEach((sfile) => {
              formData.append("removedFiles", sfile);
              });
            }

            // Dropzone 파일 추가
            console.log("Accepted Files:", myDropzone.getAcceptedFiles()); // 확인
            myDropzone.getAcceptedFiles().forEach((file) => {
                formData.append("ofile", file);
            });

            for (let [key, value] of formData.entries()) {
                console.log(key, value);
            }

            // AJAX 요청
            $.ajax({
                url: '/noticemodify_proc',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    // 성공 시 처리
                    window.location.href = "/notice";
                },
                error: function (error) {
                    // 오류 처리
                }
            });
        }
    });
});

</script>
<script th:src="@{/js/notice/noticemodify.js}"></script>
</body>
</html>